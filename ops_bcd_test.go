package m68k

import "testing"

func TestABCD(t *testing.T) {
	tests := []struct {
		name string
		init cpuState
		want cpuState
	}{
		{
			name: "000 ABCD -(A3), -(A5) cb0b",
			init: cpuState{
				D:   [8]uint32{1856846401, 1354445898, 4146924943, 2826373679, 3623155492, 2637387800, 3703044994, 1627861361},
				A:   [7]uint32{934431941, 3222578904, 3522499819, 3173488240, 3569701346, 4127928230, 2726497174},
				PC:  14561754,
				SR:  1802,
				USP: 9357560,
				SSP: 8742784,
				RAM: [][2]uint32{{14561750, 203}, {14561751, 11}, {14561752, 47}, {14561753, 29}, {2594414, 46}, {2594415, 111}, {733092, 182}, {733093, 219}, {14561754, 225}, {14561755, 90}},
			},
			want: cpuState{
				D:   [8]uint32{1856846401, 1354445898, 4146924943, 2826373679, 3623155492, 2637387800, 3703044994, 1627861361},
				A:   [7]uint32{934431941, 3222578904, 3522499819, 3173488239, 3569701346, 4127928229, 2726497174},
				PC:  14561756,
				SR:  1819,
				USP: 9357560,
				SSP: 8742784,
				RAM: [][2]uint32{{14561750, 203}, {14561751, 11}, {14561752, 47}, {14561753, 29}, {2594414, 46}, {2594415, 111}, {733092, 182}, {733093, 176}, {14561754, 225}, {14561755, 90}},
				Cycles: 18,
			},
		},
		{
			name: "500 ABCD -(A1), -(A1) c309",
			init: cpuState{
				D:   [8]uint32{688366497, 3270682939, 1743538801, 51767684, 245593339, 1940429628, 2897400330, 632476192},
				A:   [7]uint32{3392026397, 889025637, 557258654, 1384933348, 1453822227, 3122083653, 409961448},
				PC:  2084990,
				SR:  42003,
				USP: 14919678,
				SSP: 2936838,
				RAM: [][2]uint32{{2084986, 195}, {2084987, 9}, {2084988, 243}, {2084989, 58}, {16610404, 155}, {16610405, 30}, {16610402, 232}, {16610403, 92}, {2084990, 243}, {2084991, 68}},
			},
			want: cpuState{
				D:   [8]uint32{688366497, 3270682939, 1743538801, 51767684, 245593339, 1940429628, 2897400330, 632476192},
				A:   [7]uint32{3392026397, 889025635, 557258654, 1384933348, 1453822227, 3122083653, 409961448},
				PC:  2084992,
				SR:  42001,
				USP: 14919678,
				SSP: 2936838,
				RAM: [][2]uint32{{2084986, 195}, {2084987, 9}, {2084988, 243}, {2084989, 58}, {16610404, 155}, {16610405, 30}, {16610402, 232}, {16610403, 94}, {2084990, 243}, {2084991, 68}},
				Cycles: 18,
			},
		},
		{
			name: "1000 ABCD D7, D5 cb07",
			init: cpuState{
				D:   [8]uint32{1053141187, 3742733449, 252931509, 2634556884, 2410033957, 1205761078, 2262519190, 2863312100},
				A:   [7]uint32{3931531863, 233341178, 2910525705, 1300015033, 2128734241, 370894859, 4005668834},
				PC:  8799804,
				SR:  33802,
				USP: 5971690,
				SSP: 14612668,
				RAM: [][2]uint32{{8799800, 203}, {8799801, 7}, {8799802, 249}, {8799803, 222}, {8799804, 119}, {8799805, 172}},
			},
			want: cpuState{
				D:   [8]uint32{1053141187, 3742733449, 252931509, 2634556884, 2410033957, 1205761152, 2262519190, 2863312100},
				A:   [7]uint32{3931531863, 233341178, 2910525705, 1300015033, 2128734241, 370894859, 4005668834},
				PC:  8799806,
				SR:  33819,
				USP: 5971690,
				SSP: 14612668,
				RAM: [][2]uint32{{8799800, 203}, {8799801, 7}, {8799802, 249}, {8799803, 222}, {8799804, 119}, {8799805, 172}},
				Cycles: 6,
			},
		},
		{
			name: "1500 ABCD D6, D7 cf06",
			init: cpuState{
				D:   [8]uint32{2837265261, 1254609888, 1765886087, 2647906673, 2892789762, 3176389461, 2254561836, 3465212624},
				A:   [7]uint32{3140326103, 1299316319, 3567664917, 1866477584, 2869131522, 3293345951, 1890676986},
				PC:  14589712,
				SR:  34320,
				USP: 16139972,
				SSP: 1700464,
				RAM: [][2]uint32{{14589708, 207}, {14589709, 6}, {14589710, 162}, {14589711, 59}, {14589712, 252}, {14589713, 44}},
			},
			want: cpuState{
				D:   [8]uint32{2837265261, 1254609888, 1765886087, 2647906673, 2892789762, 3176389461, 2254561836, 3465212515},
				A:   [7]uint32{3140326103, 1299316319, 3567664917, 1866477584, 2869131522, 3293345951, 1890676986},
				PC:  14589714,
				SR:  34321,
				USP: 16139972,
				SSP: 1700464,
				RAM: [][2]uint32{{14589708, 207}, {14589709, 6}, {14589710, 162}, {14589711, 59}, {14589712, 252}, {14589713, 44}},
				Cycles: 6,
			},
		},
		{
			name: "2000 ABCD -(A7), -(A1) c30f",
			init: cpuState{
				D:   [8]uint32{3000634781, 1057120324, 3705999389, 592824273, 1359181682, 3511708081, 3441152909, 1070612705},
				A:   [7]uint32{858043829, 2118734329, 3910953369, 2032184257, 2547250319, 2057265631, 3101810928},
				PC:  4561332,
				SR:  542,
				USP: 11894960,
				SSP: 1589788,
				RAM: [][2]uint32{{4561328, 195}, {4561329, 15}, {4561330, 4}, {4561331, 10}, {11894958, 184}, {11894959, 200}, {4805112, 247}, {4805113, 156}, {4561332, 47}, {4561333, 177}},
			},
			want: cpuState{
				D:   [8]uint32{3000634781, 1057120324, 3705999389, 592824273, 1359181682, 3511708081, 3441152909, 1070612705},
				A:   [7]uint32{858043829, 2118734328, 3910953369, 2032184257, 2547250319, 2057265631, 3101810928},
				PC:  4561334,
				SR:  529,
				USP: 11894958,
				SSP: 1589788,
				RAM: [][2]uint32{{4561328, 195}, {4561329, 15}, {4561330, 4}, {4561331, 10}, {11894958, 184}, {11894959, 200}, {4805112, 22}, {4805113, 156}, {4561332, 47}, {4561333, 177}},
				Cycles: 18,
			},
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			runTest(t, tt.init, tt.want)
		})
	}
}

func TestSBCD(t *testing.T) {
	tests := []struct {
		name string
		init cpuState
		want cpuState
	}{
		{
			name: "000 SBCD D3, D2 8503",
			init: cpuState{
				D:   [8]uint32{342845124, 3682155058, 3735029516, 1772217720, 3884121916, 1824997711, 3565947305, 3664225138},
				A:   [7]uint32{3204852313, 1979966899, 3701895049, 4177683308, 2185839221, 3082295344, 1673787648},
				PC:  31582,
				SR:  8479,
				USP: 14868614,
				SSP: 4445112,
				RAM: [][2]uint32{{31578, 133}, {31579, 3}, {31580, 227}, {31581, 248}, {31582, 67}, {31583, 95}},
			},
			want: cpuState{
				D:   [8]uint32{342845124, 3682155058, 3735029555, 1772217720, 3884121916, 1824997711, 3565947305, 3664225138},
				A:   [7]uint32{3204852313, 1979966899, 3701895049, 4177683308, 2185839221, 3082295344, 1673787648},
				PC:  31584,
				SR:  8467,
				USP: 14868614,
				SSP: 4445112,
				RAM: [][2]uint32{{31578, 133}, {31579, 3}, {31580, 227}, {31581, 248}, {31582, 67}, {31583, 95}},
				Cycles: 6,
			},
		},
		{
			name: "500 SBCD D2, D5 8b02",
			init: cpuState{
				D:   [8]uint32{2478285018, 2156866910, 1581721079, 1059196777, 2735046602, 1525209043, 3734773321, 2282455679},
				A:   [7]uint32{3539882295, 3073542695, 2033294859, 3016050066, 115818120, 3830833547, 3952894779},
				PC:  16529720,
				SR:  9985,
				USP: 4978858,
				SSP: 502738,
				RAM: [][2]uint32{{16529716, 139}, {16529717, 2}, {16529718, 117}, {16529719, 68}, {16529720, 144}, {16529721, 202}},
			},
			want: cpuState{
				D:   [8]uint32{2478285018, 2156866910, 1581721079, 1059196777, 2735046602, 1525208950, 3734773321, 2282455679},
				A:   [7]uint32{3539882295, 3073542695, 2033294859, 3016050066, 115818120, 3830833547, 3952894779},
				PC:  16529722,
				SR:  10003,
				USP: 4978858,
				SSP: 502738,
				RAM: [][2]uint32{{16529716, 139}, {16529717, 2}, {16529718, 117}, {16529719, 68}, {16529720, 144}, {16529721, 202}},
				Cycles: 6,
			},
		},
		{
			name: "1000 SBCD -(A0), -(A0) 8108",
			init: cpuState{
				D:   [8]uint32{3235655401, 1494498131, 4229108421, 1243298640, 1045151744, 3830287692, 27956761, 2293923708},
				A:   [7]uint32{297370965, 4178527571, 1147597022, 1015317860, 2077573406, 61270622, 2597496020},
				PC:  15467766,
				SR:  1552,
				USP: 16083378,
				SSP: 101916,
				RAM: [][2]uint32{{15467762, 129}, {15467763, 8}, {15467764, 137}, {15467765, 66}, {12158292, 36}, {12158293, 93}, {12158290, 157}, {12158291, 177}, {15467766, 113}, {15467767, 30}},
			},
			want: cpuState{
				D:   [8]uint32{3235655401, 1494498131, 4229108421, 1243298640, 1045151744, 3830287692, 27956761, 2293923708},
				A:   [7]uint32{297370963, 4178527571, 1147597022, 1015317860, 2077573406, 61270622, 2597496020},
				PC:  15467768,
				SR:  1544,
				USP: 16083378,
				SSP: 101916,
				RAM: [][2]uint32{{15467762, 129}, {15467763, 8}, {15467764, 137}, {15467765, 66}, {12158292, 36}, {12158293, 93}, {12158290, 157}, {12158291, 134}, {15467766, 113}, {15467767, 30}},
				Cycles: 18,
			},
		},
		{
			name: "1500 SBCD -(A0), -(A5) 8b08",
			init: cpuState{
				D:   [8]uint32{4266187411, 2356653191, 2838010241, 993694739, 2857089857, 3988860074, 3539126226, 1100965592},
				A:   [7]uint32{4051446050, 4204672363, 1122565803, 104417355, 1274089878, 2390586928, 4187825068},
				PC:  4024428,
				SR:  9503,
				USP: 10970574,
				SSP: 6171974,
				RAM: [][2]uint32{{4024424, 139}, {4024425, 8}, {4024426, 182}, {4024427, 140}, {8136992, 120}, {8136993, 118}, {8222254, 202}, {8222255, 43}, {4024428, 51}, {4024429, 60}},
			},
			want: cpuState{
				D:   [8]uint32{4266187411, 2356653191, 2838010241, 993694739, 2857089857, 3988860074, 3539126226, 1100965592},
				A:   [7]uint32{4051446049, 4204672363, 1122565803, 104417355, 1274089878, 2390586927, 4187825068},
				PC:  4024430,
				SR:  9491,
				USP: 10970574,
				SSP: 6171974,
				RAM: [][2]uint32{{4024424, 139}, {4024425, 8}, {4024426, 182}, {4024427, 140}, {8136992, 120}, {8136993, 118}, {8222254, 202}, {8222255, 84}, {4024428, 51}, {4024429, 60}},
				Cycles: 18,
			},
		},
		{
			name: "2000 SBCD D6, D5 8b06",
			init: cpuState{
				D:   [8]uint32{352972844, 2986954171, 889988009, 1325787342, 4158568342, 2235177776, 2325455461, 1870921354},
				A:   [7]uint32{3983984537, 1574303238, 2885939812, 1879903544, 643820467, 988881854, 2979772562},
				PC:  11997714,
				SR:  1040,
				USP: 378414,
				SSP: 7001296,
				RAM: [][2]uint32{{11997710, 139}, {11997711, 6}, {11997712, 119}, {11997713, 53}, {11997714, 149}, {11997715, 22}},
			},
			want: cpuState{
				D:   [8]uint32{352972844, 2986954171, 889988009, 1325787342, 4158568342, 2235177828, 2325455461, 1870921354},
				A:   [7]uint32{3983984537, 1574303238, 2885939812, 1879903544, 643820467, 988881854, 2979772562},
				PC:  11997716,
				SR:  1043,
				USP: 378414,
				SSP: 7001296,
				RAM: [][2]uint32{{11997710, 139}, {11997711, 6}, {11997712, 119}, {11997713, 53}, {11997714, 149}, {11997715, 22}},
				Cycles: 6,
			},
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			runTest(t, tt.init, tt.want)
		})
	}
}

func TestNBCD(t *testing.T) {
	tests := []struct {
		name string
		init cpuState
		want cpuState
	}{
		{
			name: "000 NBCD (A5) 4815",
			init: cpuState{
				D:   [8]uint32{3947492722, 2101188238, 3877388413, 2880202079, 3496940104, 2080798772, 855030407, 3238153236},
				A:   [7]uint32{3346786243, 3402273506, 17325089, 1967330530, 2548317449, 3666971369, 2227404207},
				PC:  8724470,
				SR:  34589,
				USP: 8392382,
				SSP: 10983750,
				RAM: [][2]uint32{{8724466, 72}, {8724467, 21}, {8724468, 174}, {8724469, 168}, {9538280, 211}, {9538281, 158}, {8724470, 226}, {8724471, 139}},
			},
			want: cpuState{
				D:   [8]uint32{3947492722, 2101188238, 3877388413, 2880202079, 3496940104, 2080798772, 855030407, 3238153236},
				A:   [7]uint32{3346786243, 3402273506, 17325089, 1967330530, 2548317449, 3666971369, 2227404207},
				PC:  8724472,
				SR:  34585,
				USP: 8392382,
				SSP: 10983750,
				RAM: [][2]uint32{{8724466, 72}, {8724467, 21}, {8724468, 174}, {8724469, 168}, {9538280, 211}, {9538281, 251}, {8724470, 226}, {8724471, 139}},
				Cycles: 12,
			},
		},
		{
			name: "500 NBCD (d16, A1) 4829",
			init: cpuState{
				D:   [8]uint32{70152342, 1784813261, 3919101849, 2007753937, 1393095342, 2985081749, 916929108, 4161358118},
				A:   [7]uint32{1757798470, 2840526489, 2563841600, 3971062173, 529815522, 2501963399, 3039276366},
				PC:  1526928,
				SR:  8453,
				USP: 15571458,
				SSP: 5061116,
				RAM: [][2]uint32{{1526924, 72}, {1526925, 41}, {1526926, 131}, {1526927, 163}, {1526928, 179}, {1526929, 145}, {5145148, 136}, {5145149, 91}, {1526930, 58}, {1526931, 131}},
			},
			want: cpuState{
				D:   [8]uint32{70152342, 1784813261, 3919101849, 2007753937, 1393095342, 2985081749, 916929108, 4161358118},
				A:   [7]uint32{1757798470, 2840526489, 2563841600, 3971062173, 529815522, 2501963399, 3039276366},
				PC:  1526932,
				SR:  8465,
				USP: 15571458,
				SSP: 5061116,
				RAM: [][2]uint32{{1526924, 72}, {1526925, 41}, {1526926, 131}, {1526927, 163}, {1526928, 179}, {1526929, 145}, {5145148, 18}, {5145149, 91}, {1526930, 58}, {1526931, 131}},
				Cycles: 16,
			},
		},
		{
			name: "1000 NBCD (A7) 4817",
			init: cpuState{
				D:   [8]uint32{3425456517, 3378506001, 2007119008, 2379332692, 2100336854, 1403739600, 838668799, 2737300943},
				A:   [7]uint32{3091487772, 1195413189, 1800091857, 2369113421, 812703392, 2261886665, 3014117261},
				PC:  8224686,
				SR:  41742,
				USP: 10479356,
				SSP: 13747082,
				RAM: [][2]uint32{{8224682, 72}, {8224683, 23}, {8224684, 98}, {8224685, 193}, {13747082, 129}, {13747083, 194}, {8224686, 65}, {8224687, 225}},
			},
			want: cpuState{
				D:   [8]uint32{3425456517, 3378506001, 2007119008, 2379332692, 2100336854, 1403739600, 838668799, 2737300943},
				A:   [7]uint32{3091487772, 1195413189, 1800091857, 2369113421, 812703392, 2261886665, 3014117261},
				PC:  8224688,
				SR:  41745,
				USP: 10479356,
				SSP: 13747082,
				RAM: [][2]uint32{{8224682, 72}, {8224683, 23}, {8224684, 98}, {8224685, 193}, {13747082, 25}, {13747083, 194}, {8224686, 65}, {8224687, 225}},
				Cycles: 12,
			},
		},
		{
			name: "1500 NBCD (d8, A1, Xn) 4831",
			init: cpuState{
				D:   [8]uint32{4072350527, 3541140331, 3845356876, 2478513751, 3656011433, 817635394, 3109192364, 843031825},
				A:   [7]uint32{677000557, 3895230611, 2101690189, 1149624036, 2451054759, 464760283, 372879774},
				PC:  10629576,
				SR:  41487,
				USP: 9843058,
				SSP: 9111198,
				RAM: [][2]uint32{{10629572, 72}, {10629573, 49}, {10629574, 12}, {10629575, 21}, {10629576, 61}, {10629577, 125}, {15180774, 245}, {15180775, 36}, {10629578, 124}, {10629579, 43}},
			},
			want: cpuState{
				D:   [8]uint32{4072350527, 3541140331, 3845356876, 2478513751, 3656011433, 817635394, 3109192364, 843031825},
				A:   [7]uint32{677000557, 3895230611, 2101690189, 1149624036, 2451054759, 464760283, 372879774},
				PC:  10629580,
				SR:  41491,
				USP: 9843058,
				SSP: 9111198,
				RAM: [][2]uint32{{10629572, 72}, {10629573, 49}, {10629574, 12}, {10629575, 21}, {10629576, 61}, {10629577, 125}, {15180774, 245}, {15180775, 118}, {10629578, 124}, {10629579, 43}},
				Cycles: 18,
			},
		},
		{
			name: "2000 NBCD (d8, A5, Xn) 4835",
			init: cpuState{
				D:   [8]uint32{912491499, 917400088, 3793424683, 3933536407, 2649635767, 2882087297, 787638188, 2515214780},
				A:   [7]uint32{4066238975, 564310580, 3274878217, 3988183763, 3046038491, 1629312099, 1134846177},
				PC:  9225534,
				SR:  9748,
				USP: 1306188,
				SSP: 13047938,
				RAM: [][2]uint32{{9225530, 72}, {9225531, 53}, {9225532, 68}, {9225533, 137}, {9225534, 232}, {9225535, 195}, {1937314, 196}, {1937315, 129}, {9225536, 80}, {9225537, 90}},
			},
			want: cpuState{
				D:   [8]uint32{912491499, 917400088, 3793424683, 3933536407, 2649635767, 2882087297, 787638188, 2515214780},
				A:   [7]uint32{4066238975, 564310580, 3274878217, 3988183763, 3046038491, 1629312099, 1134846177},
				PC:  9225538,
				SR:  9745,
				USP: 1306188,
				SSP: 13047938,
				RAM: [][2]uint32{{9225530, 72}, {9225531, 53}, {9225532, 68}, {9225533, 137}, {9225534, 232}, {9225535, 195}, {1937314, 196}, {1937315, 24}, {9225536, 80}, {9225537, 90}},
				Cycles: 18,
			},
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			runTest(t, tt.init, tt.want)
		})
	}
}
